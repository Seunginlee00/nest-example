<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŒ€í™”ë°©</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .chat-container {
      max-width: 400px;
      margin: 0 auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    .chat-header {
      background: #f5f5f5;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    .chat-messages {
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #fafafa;
    }
    .message {
      margin: 10px 0;
      padding: 8px;
      border-radius: 8px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .message.me {
      background: #FEEBC8;
      margin-left: auto;
      text-align: right;
    }
    .message.other {
      background: #C6F6D5;
      margin-right: auto;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #ddd;
    }
    .chat-input select, .chat-input input, .chat-input button {
      padding: 8px;
      border: none;
      outline: none;
    }
    .chat-input select {
      width: 30%;
    }
    .chat-input input {
      flex: 1;
    }
    .chat-input button {
      background: #22543D;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">
    ëŒ€í™”ë°© - <%= roomId %>
  </div>

<div class="chat-messages" id="messages">
  <% messages.forEach(msg => { %>
    <div class="message other">
      <strong><%= msg.target_name %></strong>
      <%= msg.msg %><br>
      <small><%= msg.reg_datetime %></small>
    </div>
  <% }) %>
</div>

  <div class="chat-input">
    <select id="sender">
      <% memberList.forEach(member => { %>
        <option value="<%= member.cm_idx %>"><%= member.user_name %></option>
      <% }) %>
    </select>
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”..." required>
    <button onclick="send()">Send</button>
  </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const client = mqtt.connect('ws://115.68.194.78:8888'); // ðŸ‘‰ ì—¬ê¸° MQTT WebSocket ì£¼ì†Œ
  const roomId = "<%= roomId %>";
  const topic = `chatting/${roomId}`;

  client.on('connect', () => {
    console.log('MQTT connected');
    client.subscribe(topic);
  });

  client.on('message', (recvTopic, payload) => {
    if (recvTopic === topic) {
      const msg = JSON.parse(payload.toString());
      addMessage(msg.sender, msg.message, msg.time);
    }
  });

    function send() {
    const sender = parseInt(document.getElementById('sender').value, 10);
    const message = document.getElementById('message').value;
    if (!message) return;

    fetch(`/chat/room/${roomId}/send`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
        sender,
        message
        })
    });

    document.getElementById('message').value = '';
    }

  function addMessage(sender, message, time) {
    const container = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = `message ${sender === 'me' ? 'me' : 'other'}`;
    div.innerHTML = `${sender}: ${message}<br><small>${time}</small>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }
</script>
</body>
</html>
